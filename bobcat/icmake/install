void rungzip9(string src, string dest)
{
    int idx;
    string file;
    list man;

    chdir(src);
    man = makelist("*");
    chdir(g_cwd);
    for (idx = sizeof(man); idx--; )
    {
        file = element(idx, man);
        run("gzip -n -9 < " + src + file + " > " + dest + file + ".gz");
        log(dest + file + ".gz");
    }
}

void reqzip(string dest, string src)
{
    list files;
    int idx;
    string file;

    md(dest);

    files = strtok(src, " ");
    for (idx = sizeof(files); idx--; )
    {
        file = element(idx, files);
        run("gzip -n -9 < " + file + " > " + dest + file + ".gz");
        log(dest + file + ".gz");
    }
}

void runInstall(string cmd, string src, string pattern, string dest)
{
    md(dest);
    run(cmd + " " + src + " " + pattern + " " + dest);
    logFiles(src, pattern, dest);
}
    
void install(string rss, string dev)
{
    string dest;

#undefine LIBRARIES
#ifdef LIBRARIES
    printf("\n  installing the libraries\n");
    runInstall("cp " CPOPTS, g_tmpliba, "*", dev + lib);
//    dest = dev + LIB;
//    md(dest);
//    run("cp " CPOPTS " " + g_tmpliba + "* " + dest);
//    logFiles(g_tmpliba, "", dest);

#ifndef ONLY_STATIC
    runInstall("cp " CPOPTS, g_tmplibso, "*", rss + lib);
//    dest = rss + LIB;
//    md(dest);
//    run("cp " CPOPTS " " + g_tmplibso + "* " + dest);
//    logFiles(g_tmplibso, "", dest);
#endif

// OFF #ifndef ONLY_STATIC
// OFF     md(rss + LIB);
// OFF     run("cp " CPOPTS " tmp/lib/*so.* " + rss + LIB);
// OFF 
// OFF     md(dev + LIB);
// OFF     run("cp " CPOPTS " tmp/lib/*.a tmp/lib/*.so " + dev + LIB);
// OFF #else
// OFF     md(dev + LIB);
// OFF     run("cp " CPOPTS " tmp/lib/*.a " + dev + LIB);
// OFF #endif

#endif

#ifdef HEADERS
    printf("\n  installing the headers\n");
    runInstall("cp", "tmp/" LIBRARY, "*", dev + inc);
//    dest = dev + INC;
//    md(dest);
//    run("cp tmp/" LIBRARY "/* " + dest);
//    logFiles("tmp/" LIBRARY, "", dest);
#endif

#undefine MANPAGES
#ifdef MANPAGES
    printf("\n  installing the manual pages\n");
    md(dev + MAN + "/man1 "     + 
       dev + MAN + "/man3 "     + 
       dev + MAN + "/man7 "     +
       dev + DOC + "/images"    );

    run("cp documentation/images/*.jpg " + dev + DOC + "/images");
    logFiles("documentation/images/", "*.jpg", dev + DOC + "/images");

    rungzip9("tmp/man/man3/", dev + MAN + "/man3/");

    rungzip9("tmp/man/man7/", dev + MAN + "/man7/");
    
    chdir(dev + MAN + "/man3");
    run("ln -sf iterator.3bobcat.gz reverseiterator.3bobcat.gz");
    logLink("reverseiterator.3bobcat.gz");

    chdir(g_cwd);
#endif

#undefine MANHTML
#ifdef MANHTML
    printf("\n  installing the html versions of the manual pages\n");
    md(dev + DOC + "/man");

    run("cp -r tmp/manhtml/* " + dev + DOC + "/man/");
    logFiles("tmp/manhtml/", "", dev + DOC + "/man/");

    run("ln -sf " LIBRARY ".7.html " + dev + DOC + "/man/index.html");
    logLink(dev + DOC + "/man/index.html");

    run("cp documentation/man/" LIBRARY ".jpg " + dev + DOC + "/man");
    log(dev + DOC + "/man/" LIBRARY ".jpg");

    chdir(dev + DOC + "/man");
    run("ln -sf iterator.3.html reverseiterator.3.html");
    logLink("reverseiterator.3.html");

    chdir(g_cwd);
#endif


#ifdef DOCOTHER
    printf("\n  installing remaining documentation\n");
//    reqzip(dev + DOCDEV + "/", 
//            "READLINE "
//            "README "
//            "README.X11 "
//            "README.class-setup "
//            "README.immovable "
//            "README.milter "
//            "README.optimization "
//            "README.process-pipe "
//            "README.fnwrap "
//            "process-pipe.odp "
//            "process-pipe.pdf "
//            "TODO");

    logDirs("documentation/examples", dev + DOCDEV + "/examples");
    run("cp -r documentation/examples " + dev + DOCDEV);
    logFiles("documentation/examples", "", dev + DOCDEV + "/examples");

    md(dev + DOCDEV + "/scripts");
    rungzip9("scripts/", dev + DOCDEV + "/scripts/");

    if (DOC != "")
    {
        md(rss + DOC);
        reqzip(rss + DOC + "/", "README");
    }
#endif

writeLog();

    printf("\n  Installation completed\n");

    exit(0);
}


